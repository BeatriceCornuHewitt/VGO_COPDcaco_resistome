---
title: "5 - Alpha diversity"
author: "Beatrice Cornu Hewitt"
date: "`r Sys.time()`"
output: html_document
---
**
- Calculate several alpha diversity indices (Shannon, Simpson’s Evenness, Observed) for COPD and control participants
- The abundance data contains decimals as it has been corrected per gene length, therefore none are whole numbers.
- There are a maximum of 7 decimals in the dataset but alpha diversity calculations require whole numbers.
- Multiply data by 1 billion in order to remove all these decimals to do the alpha diversity calculations. 
**

# Packages
```{r}
library(ggpubr); library(microbiome); library(car)
```
# Data
```{r}
ps_noblanks <- readRDS("../Output_files/Phyloseq_objects/4b_COPD_resistome_phyloseq_object_rarefied_FPKM_noblanks.Rds") # This ps object is gene length corrected but not clustered at the 90% identity level
ps_billion <- ps_noblanks
ps_billion@otu_table@.Data <- (ps_billion@otu_table@.Data)*1000000000
head(ps_billion@otu_table@.Data)

# Firstly I will rename the codes "1" & "0" as COPD & control respectively
ps_billion@sam_data$copdcaco <- ifelse(ps_billion@sam_data$copdcaco == "1", "COPD", "Control")
```
# Alpha diversity calculations
```{r}
# Create tables with alpha diversity measures
Shannon_table <- microbiome::alpha(ps_billion, (index = "Shannon"), zeroes = TRUE)
SimpsonEvenness_table <- microbiome::alpha(ps_billion, (index = "simpson"), zeroes = TRUE)
Observed_table <-  microbiome::alpha(ps_billion, (index = "Observed"), zeroes = TRUE)

# Now add the diversity tables to the metadata
sample_data(ps_billion)$shannon <- Shannon_table$diversity_shannon
sample_data(ps_billion)$SimpsonEvenness <- SimpsonEvenness_table$evenness_simpson
sample_data(ps_billion)$Observed <- Observed_table$observed

# Check normality of the diversity score distributions
# Create histograms of diversity scores
par(mfrow = c(2, 2))
hist(sample_data(ps_billion)$shannon, main="Shannon diversity", xlab="", breaks=15)
hist(sample_data(ps_billion)$SimpsonEvenness, main="Simpson evenness diversity", xlab="", breaks=15)
hist(sample_data(ps_billion)$Observed, main="Observed diversity", xlab="", breaks=15)
# Statistical check for normality 
shapiro.test(sample_data(ps_billion)$shannon) 
shapiro.test(sample_data(ps_billion)$SimpsonEvenness) 
shapiro.test(sample_data(ps_billion)$Observed) 
# shannon normally distributed, simpson and observed not
```
# COPD case-control 
## Check assumptions
```{r}
# Extract metadata from phyloseq sam_data and create dataframe
metadata <- data.frame(ps_billion@sam_data)

# Check normality within each group (COPD case and control) using histograms and QQ plots
{par(mfrow = c(2, 2))  # Set up a multi-panel plotting layout
hist(metadata$shannon[metadata$copdcaco == "COPD"], main = "Shannon Diversity (COPD)", xlab = "Shannon Diversity")
qqnorm(metadata$shannon[metadata$copdcaco == "COPD"], main = "QQ Plot (COPD)")
qqline(metadata$shannon[metadata$copdcaco == "COPD"])

hist(metadata$shannon[metadata$copdcaco == "Control"], main = "Shannon Diversity (Control)", xlab = "Shannon Diversity")
qqnorm(metadata$shannon[metadata$copdcaco == "Control"], main = "QQ Plot (Control)")
qqline(metadata$shannon[metadata$copdcaco == "Control"])}

{par(mfrow = c(2, 2))
hist(metadata$SimpsonEvenness[metadata$copdcaco == "COPD"], main = "Simpson Evenness Diversity (COPD)", xlab = "Simpson Evenness Diversity")
qqnorm(metadata$SimpsonEvenness[metadata$copdcaco == "COPD"], main = "QQ Plot (COPD)")
qqline(metadata$SimpsonEvenness[metadata$copdcaco == "COPD"])

hist(metadata$SimpsonEvenness[metadata$copdcaco == "Control"], main = "Simpson Evenness Diversity (Control)", xlab = "Simpson Evenness Diversity")
qqnorm(metadata$SimpsonEvenness[metadata$copdcaco == "Control"], main = "QQ Plot (Control)")
qqline(metadata$SimpsonEvenness[metadata$copdcaco == "Control"])}

{par(mfrow = c(2, 2))
hist(metadata$Observed[metadata$copdcaco == "COPD"], main = "Observed Diversity (COPD)", xlab = "Observed Diversity")
qqnorm(metadata$Observed[metadata$copdcaco == "COPD"], main = "QQ Plot (COPD)")
qqline(metadata$Observed[metadata$copdcaco == "COPD"])

hist(metadata$Observed[metadata$copdcaco == "Control"], main = "Observed Diversity (Control)", xlab = "Observed Diversity")
qqnorm(metadata$Observed[metadata$copdcaco == "Control"], main = "QQ Plot (Control)")
qqline(metadata$Observed[metadata$copdcaco == "Control"])}


# Check normality statistically using Shapiro Wilk test
shapiro.test(metadata$shannon[metadata$copdcaco == "COPD"]) 
shapiro.test(metadata$shannon[metadata$copdcaco == "Control"]) 
shapiro.test(metadata$SimpsonEvenness[metadata$copdcaco == "COPD"])
shapiro.test(metadata$SimpsonEvenness[metadata$copdcaco == "Control"]) 
shapiro.test(metadata$Observed[metadata$copdcaco == "COPD"]) 
shapiro.test(metadata$Observed[metadata$copdcaco == "Control"]) 

# Check homogeneity of variance using Levene's test
leveneTest(metadata$shannon, metadata$copdcaco) 
leveneTest(metadata$SimpsonEvenness, metadata$copdcaco)
leveneTest(metadata$Observed, metadata$copdcaco)

# Summary of assumption checking: 
# Shannon: both groups normally distributed, no significant difference in variances between the COPD and Control groups. Conduct t-test between COPD case and control groups
# Simpson evenness: p-value for the COPD group suggests non-normality, no significant difference in variances between the COPD and Control groups. Conduct wilcoxon rank sum test between COPD case and control groups
# Observed: p-value for control group suggests non-normality. No significant difference in variances between the COPD and Control groups..Conduct wilcoxon rank sum test between COPD case and control groups
```
## Statistical tests
```{r}
# t-tests make the following assumptions: 
# 1: The two samples are independent of one another
# 2: homogeneity of variance assumption
# 3: The two populations are normally distributed

# Wilcoxon rank sum test makes the following assumptions:
# 1: The two samples are independent of one another
# 2: homogeneity of variance assumption

# Therefore I will use t-test for shannon (normally distributed) and Wilcoxon rank sum test (Mann-Whitney U) for the others. 

# t-test for shannon diversity
shannon_ttest_copdcaco <- t.test(metadata$shannon ~ metadata$copdcaco)
shannon_ttest_copdcaco # p-value = 0.04746 - i.e. there is (just) a significant difference in shannon alpha diversity between COPD and controls
# Wilcoxon rank sum test for Simpson evenness
wilcox_simpson <- wilcox.test(metadata$SimpsonEvenness~metadata$copdcaco)
wilcox_simpson # p-value = 0.3671
# Wilcoxon rank sum test for observed diversity
wilcox_observed <- wilcox.test(metadata$Observed~metadata$copdcaco)
wilcox_observed # p-value = 0.1708
```
## Boxplots
```{r}
theme_set(theme_cowplot())
# Create boxplots for COPD & controls 
Shannon.diversity.plot <- ggplot(metadata, aes(x = copdcaco, y = shannon)) + 
  geom_boxplot(aes(fill = factor(copdcaco)), alpha = 0.8, outlier.shape = NA, fatten = 2) + 
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    legend.position = "none"  # This line attempts to remove the legend
  ) +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab(NULL) +
  ylab("Shannon index") +
  geom_point(aes(color = factor(copdcaco)), position = "jitter", size = 3, alpha = 0.5) +
  scale_fill_manual(values = c("cornflowerblue", "orange")) +
  scale_color_manual(values = c("cornflowerblue", "orange"))

Shannon.diversity.plot.pval <- Shannon.diversity.plot + stat_compare_means(method = "t.test", size = 5, label.x = 0.6, label.y = 3.4)


Simpson.diversity.plot <- ggplot(metadata, aes(x = copdcaco, y = SimpsonEvenness)) + 
  geom_boxplot(aes(fill = factor(copdcaco)), alpha = 0.8, outlier.shape = NA, fatten = 2) + 
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    legend.position = "none"  # This line attempts to remove the legend
  ) +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab(NULL) +
  ylab("Simpson Evenness index") +
  geom_point(aes(color = factor(copdcaco)), position = "jitter", size = 3, alpha = 0.5) +
  scale_fill_manual(values = c("cornflowerblue", "orange")) +
  scale_color_manual(values = c("cornflowerblue", "orange"))

Simpson.diversity.plot.pval <- Simpson.diversity.plot + stat_compare_means(method = "wilcox.test", size=5, label.x = 0.6, label.y = 0.42)


Observed.diversity.plot <- ggplot(metadata, aes(x = copdcaco, y = Observed)) + 
  geom_boxplot(aes(fill = factor(copdcaco)), alpha = 0.8, outlier.shape = NA, fatten = 2) + 
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    legend.position = "none"  # This line attempts to remove the legend
  ) +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab(NULL) +
  ylab("Observed index") +
  geom_point(aes(color = factor(copdcaco)), position = "jitter", size = 3, alpha = 0.5) +
  scale_fill_manual(values = c("cornflowerblue", "orange")) +
  scale_color_manual(values = c("cornflowerblue", "orange"))

Observed.diversity.plot.pval <- Observed.diversity.plot + 
  stat_compare_means(method = "wilcox.test", size=5,label.x = 0.6, label.y = 100)


Shannon.diversity.plot
Simpson.diversity.plot
Observed.diversity.plot

Shannon.diversity.plot.pval
Simpson.diversity.plot.pval
Observed.diversity.plot.pval

ggsave("Output_files/Alpha_diversity/Shannon_diversity_plot.png", Shannon.diversity.plot, dpi = 1000, width = 10, height = 8)
ggsave("Output_files/Alpha_diversity/Simpson_diversity_plot.png", Simpson.diversity.plot, dpi = 1000, width = 10, height = 8)
ggsave("Output_files/Alpha_diversity/Observed_diversity_plot.png", Observed.diversity.plot, dpi = 1000, width = 10, height = 8)
```
# Livestock exposure
## Univariable linear models
```{r}
# Now we assess the impact of various livestock exposure variables on resistome alpha diversity 
# As all predictor variables are continuous and outcome is continuous too, use a linear regression model

# Run all linear regressions with all exposure proxies, set a p-value threshold and decide from there which are the important parameters to look at further
metadata <- data.frame(ps_billion@sam_data)
colnames(metadata)
# rename copdcaco as 0 and 1 
metadata$copdcaco <- factor(metadata$copdcaco)
metadata$copdcaco <- recode_factor(metadata$copdcaco, "COPD" = "1", "Control" = "0")

# Run the linear models
# Start with Shannon diversity
# I should include COPD/control status as an additional variable in the linear regression models. Potential loss of power by doing this, but doesn’t take many degrees of freedom so should include in these models.  

# Univariable linear models were used for each alpha diversity index for: the general livestock predictor (I selected the variable “N distance weighted farms within 3000m” as this was most accurate representation of the general livestock-related characteristics (compared to say “min distance to farm” etc.), Dispersion modelled endotoxin and PM10,LUR-modelled microbial concentrations

# Create a list of target variables
target_vars <- c("shannon", "SimpsonEvenness", "Observed")
# Create a list of predictor variables
predictor_vars <- c("nAnyFarmWghtDist.3000m.sum","DISP_EUinPM10_AnnualAv_WP99.5","DISP_PM10CONC_AnnualAv_WP99.5","E.coli_LUR_estimates", "E.coli_RF_predictions", "Staph_LUR_estimates", "Staph_RF_predictions","tetW_LUR_estimates", "tetW_RF_predictions", "mecA_LUR_estimates", "mecA_RF_predictions")
# Create an empty list to store model summaries
model_summaries <- list()
# Loop through each target variable
for (target in target_vars) {
  # Loop through each predictor variable
  for (predictor in predictor_vars) {
    # Construct the formula for the linear model
    formula <- as.formula(paste(target, "~", predictor, "+ copdcaco"))
    # Fit the linear model
    model <- lm(formula, data = metadata)
    # Store the model summary
    model_summary <- summary(model)
    # Print the summary
    print(model_summary)
    # Store the model summary in the list
    model_summaries[[paste(target, predictor, sep = "_")]] <- model_summary
  }
}


model_summaries


# Initialize empty lists to store data frames for each outcome variable
outcome_dfs <- list()

# Loop through each target variable
for (target_var in target_vars) {
  # Initialize an empty data frame to store results for the current target variable
  outcome_df <- data.frame(variable = character(), beta = numeric(), p_value = numeric(), stringsAsFactors = FALSE)
  # Loop through each predictor variable
  for (predictor_var in predictor_vars) {
    # Construct the formula for the linear model
    formula <- as.formula(paste(target_var, "~", predictor_var, "+ copdcaco"))
    # Fit the linear model
    model <- lm(formula, data = metadata)
    # Extract coefficient and p-value for the predictor variable
    coefficient <- coef(summary(model))[predictor_var, "Estimate"]
    p_value <- coef(summary(model))[predictor_var, "Pr(>|t|)"]
    # Store the results in the outcome data frame
    outcome_df[nrow(outcome_df) + 1, ] <- list(predictor_var, coefficient, p_value)
  }
  # Append the outcome data frame to the list of data frames
  outcome_dfs[[target_var]] <- outcome_df
}

# View the data frames for each alpha diversity index
outcome_dfs

# Change variable names for supplement table
map_names <- function(old_name) {
  new_name <- switch(old_name,
                     "nAnyFarmWghtDist.3000m.sum" = "N of distance weighted farms within 3000m",
                     "DISP_EUinPM10_AnnualAv_WP99.5" = "Dispersion-modelled endotoxin",
                     "DISP_PM10CONC_AnnualAv_WP99.5" = "Dispersion-modelled PM10",
                     "E.coli_LUR_estimates" = "LUR-modelled E. coli",
                     "E.coli_RF_predictions" = "RF-modelled E. coli",
                     "Staph_LUR_estimates" = "LUR-modelled Staphylococcus spp.",
                     "Staph_RF_predictions" = "RF-modelled Staphylococcus spp.",
                     "tetW_LUR_estimates" = "LUR-modelled tetW",
                     "tetW_RF_predictions" = "RF-modelled tetW",
                     "mecA_LUR_estimates" = "LUR-modelled mecA",
                     "mecA_RF_predictions" = "RF-modelled mecA",
                     old_name)
  return(new_name)
}

# Loop through each outcome data frame
for (outcome_var in names(outcome_dfs)) {
  # Rename the values in the "variable" column
  outcome_dfs[[outcome_var]]$variable <- sapply(outcome_dfs[[outcome_var]]$variable, map_names)
}

# View the updated data frames
outcome_dfs

new_colnames <- c("Variable", "β", "p value")
for (outcome_var in names(outcome_dfs)) {
  # Change the column names
  colnames(outcome_dfs[[outcome_var]]) <- new_colnames
}

# View the updated dataframes
outcome_dfs

# Name the dataframes accordingly
names(outcome_dfs) <- c("shannon_lm_all", "simpson_lm_all", "observed_lm_all")

# Make each dataframe in outcome_dfs a separate dataframe object in the environment
list2env(outcome_dfs, envir = .GlobalEnv)

shannon_lm_all
simpson_lm_all
observed_lm_all

# Since each alpha diversity index shows us something else, I will adjust p-values separately per index
# Perform the multiple testing correction using the Benjamini-Hochberg method
shannon_padj <- p.adjust(shannon_lm_all$`p value`, method = "BH")
shannon_lm_all$P_value_adj <- shannon_padj

simpson_padj <- p.adjust(simpson_lm_all$`p value`, method = "BH")
simpson_lm_all$P_value_adj <- simpson_padj

observed_padj <- p.adjust(observed_lm_all$`p value`, method = "BH")
observed_lm_all$P_value_adj <- observed_padj

shannon_lm_all
simpson_lm_all
observed_lm_all

write.csv(shannon_lm_all, "../Output_files/Alpha_diversity/shannon_lm_all.csv", row.names = FALSE)
write.csv(simpson_lm_all, "../Output_files/Alpha_diversity/simpson_lm_all.csv", row.names = FALSE)
write.csv(observed_lm_all, "../Output_files/Alpha_diversity/observed_lm_all.csv", row.names = FALSE)

# The BH method ranks the p-values from smallest to largest, and then calculates adjusted p-values based on their rank and the total number of tests. If multiple p-values are close to each other (e.g., have similar magnitudes), they may receive similar ranks and therefore similar or identical adjusted p-values.
```
## Multivariable models
```{r}
# Using a multivariable model for the distance weighted animals (to correct for different livestock species)
# 1000m buffer animals 
shannon_multivar_1000m <- lm(metadata$shannon ~
                                metadata$copdcaco + 
                                metadata$npigsWghtDist.1000m.sum+ 
                                metadata$npoultryWghtDist.1000m.sum + 
                                metadata$ncowsWghtDist.1000m.sum+ 
                                metadata$nhorsesWghtDist.1000m.sum+
                                metadata$ngoatsWghtDist.1000m.sum+
                                metadata$nsheepWghtDist.1000m.sum)
                             
simpson_multivar_1000m <- lm(metadata$SimpsonEvenness ~ 
                                metadata$copdcaco + 
                                metadata$npigsWghtDist.1000m.sum+ 
                                metadata$npoultryWghtDist.1000m.sum + 
                                metadata$ncowsWghtDist.1000m.sum+ 
                                metadata$nhorsesWghtDist.1000m.sum+
                                metadata$ngoatsWghtDist.1000m.sum+
                                metadata$nsheepWghtDist.1000m.sum)

observed_multivar_1000m <- lm(metadata$Observed ~ 
                                metadata$copdcaco +
                                  metadata$npigsWghtDist.1000m.sum+ 
                                metadata$npoultryWghtDist.1000m.sum + 
                                metadata$ncowsWghtDist.1000m.sum+ 
                                metadata$nhorsesWghtDist.1000m.sum+
                                metadata$ngoatsWghtDist.1000m.sum+
                                metadata$nsheepWghtDist.1000m.sum)

# 3000m buffer animals 
shannon_multivar_3000m <- lm(metadata$shannon ~
                                metadata$copdcaco + 
                                metadata$npigsWghtDist.3000m.sum+ 
                                metadata$npoultryWghtDist.3000m.sum + 
                                metadata$ncowsWghtDist.3000m.sum+ 
                                metadata$nhorsesWghtDist.3000m.sum+
                                metadata$ngoatsWghtDist.3000m.sum+
                                metadata$nsheepWghtDist.3000m.sum)

simpson_multivar_3000m <- lm(metadata$SimpsonEvenness ~ 
                                metadata$copdcaco + 
                                metadata$npigsWghtDist.3000m.sum+ 
                                metadata$npoultryWghtDist.3000m.sum + 
                                metadata$ncowsWghtDist.3000m.sum+ 
                                metadata$nhorsesWghtDist.3000m.sum+
                                metadata$ngoatsWghtDist.3000m.sum+
                                metadata$nsheepWghtDist.3000m.sum)

observed_multivar_3000m <- lm(metadata$Observed ~ 
                               metadata$copdcaco+ 
                                 metadata$npigsWghtDist.3000m.sum+ 
                                metadata$npoultryWghtDist.3000m.sum + 
                                metadata$ncowsWghtDist.3000m.sum+ 
                                metadata$nhorsesWghtDist.3000m.sum+
                                metadata$ngoatsWghtDist.3000m.sum+
                                metadata$nsheepWghtDist.3000m.sum)
                             

# Summary of the multiple linear regression models 
# 1000m buffer
summary(shannon_multivar_1000m)
summary(simpson_multivar_1000m)
summary(observed_multivar_1000m)
# 3000m buffer
summary(shannon_multivar_3000m)
summary(simpson_multivar_3000m)
summary(observed_multivar_3000m)


shannon_multivar_3000m_coeffs <- summary(shannon_multivar_3000m)$coefficients
simpson_multivar_3000m_coeffs <- summary(simpson_multivar_3000m)$coefficients
observed_multivar_3000m_coeffs <- summary(observed_multivar_3000m)$coefficients
# Define new row names
new_row_names <- c("Intercept",
                   "COPD control vs case",
                   "Number of distance weighted pigs within 3000m",
                   "Number of distance weighted poultry within 3000m",
                   "Number of distance weighted cows within 3000m",
                   "Number of distance weighted horses within 3000m",
                   "Number of distance weighted goats within 3000m",
                   "Number of distance weighted sheep within 3000m")

# Change row names for each coefficient data frame
rownames(shannon_multivar_3000m_coeffs) <- new_row_names
rownames(simpson_multivar_3000m_coeffs) <- new_row_names
rownames(observed_multivar_3000m_coeffs) <- new_row_names

# Save the summary data to a CSV file
write.csv(shannon_multivar_3000m_coeffs, "../Output_files/Alpha_diversity/shannon_multivar_3000m_coeffs.csv")
write.csv(simpson_multivar_3000m_coeffs, "../Output_files/Alpha_diversity/simpson_multivar_3000m_coeffs.csv")
write.csv(observed_multivar_3000m_coeffs, "../Output_files/Alpha_diversity/observed_multivar_3000m_coeffs.csv")
```
